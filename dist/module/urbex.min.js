/**
    * https://github.com/orison-networks/urbex#readme
    * (c) 2022 Orison Networks
    * @license MIT
    */
import{CacheClock as t}from"cache-clock";import e from"http";import n from"https";import r from"zlib";import o from"util";const s=new class{constructor(){this.t=this.detectContext()}detectContext(){if("undefined"!=typeof window&&void 0!==window.document)return"browser";if("undefined"!=typeof process&&process.versions&&process.versions.node)return"node";throw new Error("Unable to detect environment context.")}nodeStrictCheck(){if(this.isBrowser)throw new Error("This method is not available in the browser environment.")}get process(){return this.isNode?process:{}}get context(){return this.t}get isBrowser(){return"browser"===this.context}get isNode(){return"node"===this.context}get isDevelopment(){return this.nodeStrictCheck(),"development"===process.env.NODE_ENV}get isProduction(){return this.nodeStrictCheck(),"production"===process.env.NODE_ENV}};class i extends Error{static create(t){const e=new this;return e.config=t,e}static createErrorInstance(t){const e=t.create.call(t,this.config);return e.request=this.request,e}static isInstance(t){return t instanceof i}}class u extends i{constructor(){super(),this.name="TimeoutError",this.message="The request timed out."}set timeout(t){this.message=`Timeout of ${t}ms exceeded`}}class c extends i{constructor(){super(),this.name="NetworkError",this.message="Failed to request the resource."}}function a(t,e,n){var r;const o=s.isNode?n.response.statusCode:n.response.status;if(this.config.resolveStatus(this.config,o))return t(n);const u=i.createErrorInstance.call(this,i),c=`Request failed with status code ${o}`;return u.message=s.isNode?n.response.statusMessage:null!==(r=n.response.statusText)&&void 0!==r?r:c,u.request=this.request,u.status=o,u.response=n.response,e(u)}function l(t,e){return t.hasOwnProperty.call(t,e)}function f(t){return void 0===t}function h(t){return Array.isArray(t)}function d(t){return"object"==typeof t&&null!==t&&!h(t)}function p(t){return"string"==typeof t}function m(t){return"function"==typeof t}function w(t){return h(t)?0===t.length:d(t)?0===Object.keys(t).length:!t}function v(t){return String(t).toUpperCase()}function g(t){if(h(t))return t.map(g);if(d(t)&&t.constructor===Object){const e={};for(const n in t)l(t,n)&&(e[n]=g(t[n]));return e}return t}function b(t,e){return Object.assign({},t,e)}function x(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return e.reduce(((t,e)=>{if(h(e))return t.concat(e);for(const n in e)h(t[n])&&h(e[n])?t[n]=t[n].concat(e[n]):d(t[n])&&d(e[n])?t[n]=x(t[n],e[n]):t[n]=e[n];return t}),{})}function y(t,e){if(!f(t))if(h(t))t.forEach((function(n,r){e.call(null,r,n,t)}));else for(const n in t)e.call(null,n,t[n],t)}function E(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(t){const r=e.exec(t);if(h(r)&&!w(r))return r[n]}return r}function T(t,e,n){return t.replace(e,n)}function P(t,e){return j(e)?"":e.startsWith(t)?e:`${t}${e}`}function j(t){return null==t}function q(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return n.filter((t=>!w(t))).join(t)}function L(t){return t.reduce(((t,e)=>{const n=e.split(".");if(1===n.length)t[e]=null;else{const[e,...r]=n;t[e]||(t[e]={});const o=L(r);t[e]=b(t[e],o)}return t}),{})}class ${getAgentFromProtocol(t){return"https"===t?n:e}handleDataProtocolRequest(t){return new Promise(((t,e)=>{t({data:null,request:null,response:null})}))}async send(t){return new Promise(((e,n)=>{var r;const o=this.getAgentFromProtocol(t.url.protocol);if("data"===t.url.protocol)return this.handleDataProtocolRequest(t);t.headers.has("Accept-Encoding")||t.headers.set({"Accept-Encoding":"gzip, deflate, br"}),t.url.params&&!p(t.url.params)?t.url.params=t.url.params.toString():t.url.params="";const s={protocol:(":",l=t.url.protocol,j(l)?"":l.endsWith(":")?l:`${l}:`),href:t.url.href,hostname:t.url.hostname,path:q("",t.url.endpoint,t.url.params),headers:t.headers.get(),timeout:t.timeout};var l;if(t.url.port){const e=parseInt(t.url.port.toString());isNaN(e)||(s.port=e)}const f=o.request(s);function h(r){return a.call({config:t,request:f},e,n,r)}function d(e){return i.createErrorInstance.call({config:t,request:f},e)}function m(t){this.push(t)}function w(t){if(t instanceof i)return n(t);const e=d(c);return e.message=t.message,n(e)}function v(){this.complete||this.aborted||this.destroyed||(this.destroy(),f.destroy())}function g(t){h({data:Buffer.concat(this),request:f,response:t}),v.call(t)}f.on("response",(function(e){if(e.destroyed||f.destroyed)return;if("stream"===t.responseType)return h({data:e,request:f,response:e});const n=[];e.on("data",(t=>{m.call(n,t)})),e.on("error",(t=>{w.call(e,t)})),e.on("close",(()=>{v.call(e)})),e.on("end",(()=>{g.call(n,e)}))})),f.on("error",(t=>{w.call(f,t)})),t.timeout&&f.on("timeout",(function(){const e=d(u);e.timeout=t.timeout,f.destroy(e)})),f.end(null!==(r=t.data)&&void 0!==r?r:void 0)}))}}const U={br:m(null==r?void 0:r.brotliDecompress)?o.promisify(r.brotliDecompress):null,gzip:m(null==r?void 0:r.gunzip)?o.promisify(r.gunzip):null,deflate:m(null==r?void 0:r.inflate)?o.promisify(r.inflate):null,compress:m(null==r?void 0:r.createUnzip)?o.promisify(r.createUnzip):null},C=["arraybuffer","blob","document","json","text"];class A{send(t){return new Promise(((e,n)=>{const r=new XMLHttpRequest;function o(t,e){for(const{event:n,listener:o}of t)r[e](n,o)}function s(e){return i.createErrorInstance.call({config:t,request:r},e)}r.open(v(t.method),t.url.href,!0),C.includes(t.responseType)&&"json"!==t.responseType&&(r.responseType=t.responseType),f(t.data)&&t.headers.delete("Content-Type"),y(t.headers.get(),r.setRequestHeader.bind(r)),t.timeout&&(r.timeout=t.timeout);const l=[{event:"timeout",listener:function(e){const r=s(u);r.timeout=t.timeout,n(r),o(l,"removeEventListener")}},{event:"abort",listener:function(t){const e=s(i);e.message="The request was aborted.",n(e),o(l,"removeEventListener")}},{event:"error",listener:function(t){const e=s(c);n(e),o(l,"removeEventListener")}},{event:"load",listener:function(s){var i;i={data:"document"===r.responseType?r.responseXML:r.responseType&&"text"!==r.responseType?r.response:r.responseText,request:r,response:{status:r.status,statusText:r.statusText,headers:r.getAllResponseHeaders()}},a.call({config:t,request:r},e,n,i),o(l,"removeEventListener")}}];o(l,"addEventListener"),r.onreadystatechange=function(){},r.send(t.data)}))}}function O(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}L(["br","gzip","deflate","compress"]);class R{constructor(t){O(this,"$executor",null),this.$executor=t}static async process(t,e){for(const n of e){const e=await n.execute(t);if(!d(e)||j(e))throw new Error("Urbex expected a valid configuration to be returned from a pipeline.");t=t}}execute(t){return this.$executor(t)}}const N={"Content-Type":"application/json"},S=b(N,{"User-Agent":`UrbexClient (Node.js ${s.process.version}; ${s.process.platform})`}),I=["POST","PUT","PATCH"],M=L(["endpoint","hostname","href","origin","params","port","protocol","urlMount"]),D={request:[],response:[]},z={url:b(M,{protocol:"http",urlMount:"/api"}),timeout:0,method:"GET",headers:null,data:null,cache:{},pipelines:D,maxContentLength:1/0,responseType:"json",responseEncoding:"utf8",resolveStatus:(t,e)=>e>=200&&e<300},H=L(["status","statusText","headers","data","config","request","response","duration","timestamp","cache.key","cache.hit","cache.pulled","cache.stored"]);function k(t){return T(t,"\n","")}function B(t){if(t){const n=function(t){return t.split("-").map((t=>{const e=k(t).trim();if(e)return function(t){return 1===(t=String(t)).length?t.toUpperCase():t.charAt(0).toUpperCase()+t.slice(1)}(e)})).join("-")}((e=t,String(e).toLowerCase())).trim();return k(n)}var e}function F(t){if(!f(t)&&!1!==t&&null!==t)return h(t)?t.join(", "):d(t)?JSON.stringify(t):k(t.toString().trim())}class G{constructor(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];O(this,"$headers",{}),e&&this.set(this.defaults,!1),d(t)&&!w(t)&&this.set(t,e)}static construct(){return new G(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},!(arguments.length>1&&void 0!==arguments[1])||arguments[1])}static parse(t){if(j(t)||!p(t))return{};const e={};return y(t.split("\r"),((t,n)=>{const[r,o]=n.toString().split(":"),s=B(r),i=F(o);s&&i&&(e[s]=i)})),e}get defaults(){return s.isNode?S:N}set(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!d(t))return n="Attempted to set headers with a non-object value: "+typeof t,console.error(`[urbex] ${n}`),t;var n;const r=this.normalize(t),o=e?b(this.$headers,r):r;return this.$headers=o}get(){return this.$headers}has(t){return l(this.$headers,B(t))}delete(t){y(this.$headers,(e=>{e.toLowerCase()===t.toLowerCase()&&delete this.$headers[e]}))}clear(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.$headers={},t||this.set(this.defaults,!1)}normalize(t){return j(t)||!d(t)?{}:function(t){const e={};return y(t,((t,n)=>{if(f(t)||f(n))return;const r=B(t),o=F(n);r&&o&&(e[r]=o)})),e}(t)}}class J{constructor(){this.register(s.context),this.$cache=new t({autoStart:!1,debug:!1})}register(t){if("browser"!==t){if("node"!==t)throw new Error(`Urbex expected a valid context to register a request api, but got ${t}.`);this.$api=new $}else this.$api=new A}async dispatchRequest(t){try{const e=g(t),n=await async function(t){const e=Date.now(),n=(new Date).toISOString(),r=g(H);return w(t.pipelines.request)||await R.process(t,t.pipelines.request),async function(o){let i=x(r,{data:o.data,config:t,request:o.request||{},response:o.response||{},timestamp:n,responseType:t.responseType,cache:o.cache||{}});if(i.cache&&i.cache.hit){const t=200,e="Pulled from internal cache";s.isNode?(i.response.statusCode=t,i.response.statusMessage=e):(i.response.status=t,i.response.statusText=e)}if(i.response)if(i.headers=i.response.headers,s.isNode)i.status=i.response.statusCode,i.statusText=i.response.statusMessage;else{const t=G.parse(i.headers);i.headers=t,i.status=i.response.status,i.statusText=i.response.statusText}w(t.pipelines.response)||await R.process(i,t.pipelines.response);const u=Date.now()-e;return i.duration=u,Promise.resolve(i)}}(e),r=e.cache&&e.cache.enabled;if(r){const t=this.$cache.getCacheKey(e.url.href),r=this.$cache.get(t,!0);if(r){const e=await n({data:r.v,request:null,response:null,cache:{key:t,pulled:!0,hit:!0,stored:!1}});return Promise.resolve(e)}}const o=await this.$api.send(e),i=await n(o);return r&&!f(i.data)&&(this.$cache.set(e.url.href,i.data),i.cache.key=this.$cache.getCacheKey(e.url.href),i.cache.stored=!0),i.cache.hit=r,Promise.resolve(i)}catch(e){if(i.isInstance(e))return Promise.reject(e);const n=i.create(t);return n.message=e.message,Promise.reject(n)}}}const X=["stream","raw"],K=new R((t=>(I.includes(v(t.method))?t.headers.set({"Content-Type":"application/x-www-form-urlencoded"}):t.data=void 0,Promise.resolve(t)))),Q=new R((async t=>{const{responseType:e,maxContentLength:n}=t.config;if(X.includes(e)||t.cache.pulled)return Promise.resolve(t);const r=t.headers["content-encoding"];if(Buffer.isBuffer(t.data)&&t.data.length){if(r){const e=U[r];if(e){const r=await e(t.data);if((n>-1||n!==1/0)&&r.length>n)throw new Error(`Content length of ${r.length} exceeds the maxContentLength of ${n}`);t.data=r}}}else t.data=null;return Promise.resolve(t)})),V=new R((t=>{const{responseType:e,responseEncoding:n}=t.config;if(X.includes(e)||"arraybuffer"===e||t.cache.pulled)return Promise.resolve(t);if(t.data){let r=t.data;s.isNode&&(r=t.data.toString(n)),t.data="json"===e?function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{return JSON.parse(t)}catch(n){return e?t:null}}(r,!0):r}return Promise.resolve(t)})),W=/^(?:([a-z]+):\/\/)?([^:\/\n]+)/i,Y=["PUT","POST","PATCH","OPTIONS","HEAD","GET","DELETE"];function Z(t){try{return new URL(t),!0}catch(t){return!1}}function _(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const n=new URL(t),r=T(n.protocol,":",""),o=n.port?parseInt(n.port):"",s=T(n.pathname,e,"");return{href:n.href,origin:n.origin,protocol:r,hostname:n.hostname,port:o,endpoint:s,params:n.search,urlMount:e}}function tt(t){let e="{protocol+://}{hostname}{:+port}{urlMount}{endpoint}{?+params}";return j(t)||w(t)||!d(t)?"":(t.params&&(t.params=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"string";if(j(t))return null;try{const n=new URLSearchParams(t);if("object"===e){const t={};return n.forEach(((e,n)=>{t[n]=e})),t}return n.toString()}catch(t){return null}}(t.params)),y(t,((t,n)=>{const r=new RegExp(`[{][^{{]*\\b${t}\\b[^{}]*[}]`,"gi");if(j(n)||w(n))e=T(e,r,"");else{const o=E(e,r,0,""),s=T(o,t,n.toString()).replace(/\+/g,"").replace(/^\{/,"").replace(/\}$/,"");e=T(e,o,s)}})),e)}function et(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(p(t)){if(Z(t))return _(t);if(e)return{endpoint:P("/",t)};throw new Error("An invalid URL was provided. A valid URL string in the format of <scheme>://<hostname> must be passed when using `urbex.configure()`.")}if(d(t)){const e=E(t.protocol,W,0,"http"),n=T(t.hostname,new RegExp(`^${e}://`,"gi"),""),r=P("/",t.endpoint),o=P("/",t.urlMount);return _(tt(b(t,{protocol:e,hostname:n,endpoint:r,urlMount:o})),o)}throw new Error("Unable to parse the provided URI. Must be either a string or an object.")}function nt(){const t=b(M,{protocol:"https",urlMount:"/api"});if(s.isBrowser){const{protocol:e,hostname:n,port:r}=window.location;Object.assign(t,{protocol:e.replace(":",""),hostname:n,port:r})}else s.isNode&&Object.assign(t,{protocol:"http",hostname:"localhost",port:3e3});return t}class rt{constructor(t){this.setup(),d(t)&&!w(t)&&this.set(this.createConfigurationObject(t,!0))}setup(){const t=et(nt()),e=g(D);e.request.push(K),e.response.push(V),s.isNode&&e.response.unshift(Q);const n=x(z,{url:t,headers:new G,pipelines:e});this.set(n)}defaultConfig(){return b(z,{url:et(nt()),headers:new G})}createConfigurationObject(t,e){const n=this.parseIncomingConfig(t,e);return this.merge(n)}parseIncomingConfig(t,e){var n,r,o,s;if(j(t)||!d(t))throw new Error("The configuration must be an object with valid properties.");const i=h(u=t)?u.slice():d(u)?Object.assign({},u):u;var u;if(l(i,"url")){const t=this.get().url;d(i.url)&&(i.url=b(t,i.url)),e&&i.url.toString().startsWith("/")&&(i.url=b(t,{endpoint:i.url}));const n=et(i.url,e);i.url=n}if(l(i,"method")){const t=v(i.method);if(!Y.includes(t))throw new Error(`The method ${t} is not a valid HTTP method.`);i.method=t}const c=parseInt(null!==(n=null===(r=i.timeout)||void 0===r?void 0:r.toString())&&void 0!==n?n:z.timeout.toString());isNaN(c)&&(i.timeout=z.timeout);const a=parseInt(null!==(o=null===(s=i.maxContentLength)||void 0===s?void 0:s.toString())&&void 0!==o?o:z.maxContentLength.toString());isNaN(a)&&(i.maxContentLength=z.maxContentLength),m(t.resolveStatus)||(t.resolveStatus=z.resolveStatus);const f=G.construct(i.headers,!0);return delete i.headers,b(i,{headers:f})}set(t){return this.$config=t,t}merge(t){var e,n;if(j(t)||!d(t))return this.get();const r=this.get(),o=null!==(e=null===(n=t.headers)||void 0===n?void 0:n.get())&&void 0!==e?e:{},s=b(r.headers,o);return delete t.headers,b(x(r,t),{headers:G.construct(s)})}get(){return this.$config}reset(){this.setup()}}function ot(t,e,n){if(j(e))throw new Error("Attempted to call a HTTP method without providing a URL. If you want to use the default URL, use `urbex.send` instead.");return b(n,{url:e,method:t})}class st extends J{constructor(t){super(),this.$config=new rt,d(t)&&!w(t)&&this.configure(t)}static create(t){return new st(t)}get config(){return this.$config.get()}get cache(){return this.$cache}configure(t){const e=this.$config.createConfigurationObject(t,!1);this.$config.set(e);const n=this.$cache;function r(){n&&(n.clear(),n.isRunning&&n.stop())}w(e.cache)?r():(n.configure(e.cache),e.cache.enabled?n&&n.isRunning||n.start():!1===e.cache.enabled&&r())}send(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this.$config.parseIncomingConfig(t,!0),n=this.$config.merge(e);return this.dispatchRequest(n)}injectPipeline(){}ejectPipeline(){}subscribe(){}unsubscribe(){}reset(){this.$cache&&(this.$cache.clear(),this.$cache.isRunning&&this.$cache.stop()),this.$config.reset()}}function it(t){return t instanceof st}y(["delete","get","head","options"],((t,e)=>{st.prototype[e]=function(t,n){return this.send(ot(v(e),t,n))}})),y(["post","put","patch"],((t,e)=>{st.prototype[e]=function(t,n,r){const o=f(n)?n:d(r)?b(r,{data:n}):{data:n};return this.send(ot(v(e),t,o))}}));const ut=function(){const t=st.create();return t.isolateClient=st.create,t.environment=s,t.isUrbexClient=it,t.Client=st,t}();export{R as PipelineExecutor,ut as default};
//# sourceMappingURL=urbex.min.js.map
