/**
    * https://github.com/orison-networks/urbex#readme
    * (c) 2022 Orison Networks
    * @license MIT
    */
"use strict";Object.defineProperty(exports,"t",{value:!0});const t=require("cache-clock"),e=require("http"),n=require("https"),r=require("zlib"),o=require("util"),s=new class{constructor(){this.o=this.detectContext()}detectContext(){if("undefined"!=typeof window&&void 0!==window.document)return"browser";if("undefined"!=typeof process&&process.versions&&process.versions.node)return"node";throw new Error("Unable to detect environment context.")}nodeStrictCheck(){if(this.isBrowser)throw new Error("This method is not available in the browser environment.")}get process(){return this.isNode?process:{}}get context(){return this.o}get isBrowser(){return"browser"===this.context}get isNode(){return"node"===this.context}get isDevelopment(){return this.nodeStrictCheck(),"development"===process.env.NODE_ENV}get isProduction(){return this.nodeStrictCheck(),"production"===process.env.NODE_ENV}};class i extends Error{static create(t){const e=new this;return e.config=t,e}static createErrorInstance(t){const e=t.create.call(t,this.config);return e.request=this.request,e}static isInstance(t){return t instanceof i}}class u extends i{constructor(){super(),this.name="TimeoutError",this.message="The request timed out."}set timeout(t){this.message=`Timeout of ${t}ms exceeded`}}class c extends i{constructor(){super(),this.name="NetworkError",this.message="Failed to request the resource."}}function a(t,e,n){const r=s.isNode?n.response.statusCode:n.response.status;if(this.config.resolveStatus(this.config,r))return t(n);const o=i.createErrorInstance.call(this,i),u=`Request failed with status code ${r}`;return o.message=s.isNode?n.response.statusMessage:n.response.statusText??u,o.request=this.request,o.status=r,o.response=n.response,e(o)}function h(t,e){return t.hasOwnProperty.call(t,e)}function f(t){return void 0===t}function l(t){return Array.isArray(t)}function d(t){return"object"==typeof t&&null!==t&&!l(t)}function p(t){return"string"==typeof t}function m(t){return"function"==typeof t}function w(t){return l(t)?0===t.length:d(t)?0===Object.keys(t).length:!t}function g(t){return String(t).toUpperCase()}function v(t){if(l(t))return t.map(v);if(d(t)&&t.constructor===Object){const e={};for(const n in t)h(t,n)&&(e[n]=v(t[n]));return e}return t}function b(t,e){return Object.assign({},t,e)}function x(...t){return t.reduce(((t,e)=>{if(l(e))return t.concat(e);for(const n in e)l(t[n])&&l(e[n])?t[n]=t[n].concat(e[n]):d(t[n])&&d(e[n])?t[n]=x(t[n],e[n]):t[n]=e[n];return t}),{})}function E(t,e){if(!f(t))if(l(t))t.forEach((function(n,r){e.call(null,r,n,t)}));else for(const n in t)e.call(null,n,t[n],t)}function T(t,e,n=0,r=null){if(t){const r=e.exec(t);if(l(r)&&!w(r))return r[n]}return r}function y(t,e,n){return t.replace(e,n)}function P(t,e){return q(e)?"":e.startsWith(t)?e:`${t}${e}`}function q(t){return null==t}function j(t="",...e){return e.filter((t=>!w(t))).join(t)}function L(t){return t.reduce(((t,e)=>{const n=e.split(".");if(1===n.length)t[e]=null;else{const[e,...r]=n;t[e]||(t[e]={});const o=L(r);t[e]=b(t[e],o)}return t}),{})}class ${getAgentFromProtocol(t){return"https"===t?n:e}handleDataProtocolRequest(t){return new Promise(((t,e)=>{t({data:null,request:null,response:null})}))}async send(t){return new Promise(((e,n)=>{const r=this.getAgentFromProtocol(t.url.protocol);if("data"===t.url.protocol)return this.handleDataProtocolRequest(t);t.headers.has("Accept-Encoding")||t.headers.set({"Accept-Encoding":"gzip, deflate, br"}),t.url.params&&!p(t.url.params)?t.url.params=t.url.params.toString():t.url.params="";const o={protocol:(":",s=t.url.protocol,q(s)?"":s.endsWith(":")?s:`${s}:`),href:t.url.href,hostname:t.url.hostname,path:j("",t.url.endpoint,t.url.params),headers:t.headers.get(),timeout:t.timeout};var s;if(t.url.port){const e=parseInt(t.url.port.toString());isNaN(e)||(o.port=e)}const h=r.request(o);function f(r){return a.call({config:t,request:h},e,n,r)}function l(e){return i.createErrorInstance.call({config:t,request:h},e)}function d(t){this.push(t)}function m(t){if(t instanceof i)return n(t);const e=l(c);return e.message=t.message,n(e)}function w(){this.complete||this.aborted||this.destroyed||(this.destroy(),h.destroy())}function g(t){f({data:Buffer.concat(this),request:h,response:t}),w.call(t)}h.on("response",(function(e){if(e.destroyed||h.destroyed)return;if("stream"===t.responseType)return f({data:e,request:h,response:e});const n=[];e.on("data",(t=>{d.call(n,t)})),e.on("error",(t=>{m.call(e,t)})),e.on("close",(()=>{w.call(e)})),e.on("end",(()=>{g.call(n,e)}))})),h.on("error",(t=>{m.call(h,t)})),t.timeout&&h.on("timeout",(function(){const e=l(u);e.timeout=t.timeout,h.destroy(e)})),h.end(t.data??void 0)}))}}const U={br:m(null==r?void 0:r.brotliDecompress)?o.promisify(r.brotliDecompress):null,gzip:m(null==r?void 0:r.gunzip)?o.promisify(r.gunzip):null,deflate:m(null==r?void 0:r.inflate)?o.promisify(r.inflate):null,compress:m(null==r?void 0:r.createUnzip)?o.promisify(r.createUnzip):null},C=["arraybuffer","blob","document","json","text"];class O{send(t){return new Promise(((e,n)=>{const r=new XMLHttpRequest;function o(t,e){for(const{event:n,listener:o}of t)r[e](n,o)}function s(e){return i.createErrorInstance.call({config:t,request:r},e)}r.open(g(t.method),t.url.href,!0),C.includes(t.responseType)&&"json"!==t.responseType&&(r.responseType=t.responseType),f(t.data)&&t.headers.delete("Content-Type"),E(t.headers.get(),r.setRequestHeader.bind(r)),t.timeout&&(r.timeout=t.timeout);const h=[{event:"timeout",listener:function(e){const r=s(u);r.timeout=t.timeout,n(r),o(h,"removeEventListener")}},{event:"abort",listener:function(t){const e=s(i);e.message="The request was aborted.",n(e),o(h,"removeEventListener")}},{event:"error",listener:function(t){const e=s(c);n(e),o(h,"removeEventListener")}},{event:"load",listener:function(s){var i;i={data:"document"===r.responseType?r.responseXML:r.responseType&&"text"!==r.responseType?r.response:r.responseText,request:r,response:{status:r.status,statusText:r.statusText,headers:r.getAllResponseHeaders()}},a.call({config:t,request:r},e,n,i),o(h,"removeEventListener")}}];o(h,"addEventListener"),r.onreadystatechange=function(){},r.send(t.data)}))}}L(["br","gzip","deflate","compress"]);class R{$executor=null;constructor(t){this.$executor=t}static async process(t,e){for(const n of e){const e=await n.execute(t);if(!d(e)||q(e))throw new Error("Urbex expected a valid configuration to be returned from a pipeline.");t=t}}execute(t){return this.$executor(t)}}const A={"Content-Type":"application/json"},N=b(A,{"User-Agent":`UrbexClient (Node.js ${s.process.version}; ${s.process.platform})`}),S=["POST","PUT","PATCH"],I=L(["endpoint","hostname","href","origin","params","port","protocol","urlMount"]),M={request:[],response:[]},D={url:b(I,{protocol:"http",urlMount:"/api"}),timeout:0,method:"GET",headers:null,data:null,cache:{},pipelines:M,maxContentLength:1/0,responseType:"json",responseEncoding:"utf8",resolveStatus:(t,e)=>e>=200&&e<300},z=L(["status","statusText","headers","data","config","request","response","duration","timestamp","cache.key","cache.hit","cache.pulled","cache.stored"]);function H(t){return y(t,"\n","")}function k(t){if(t){const n=function(t){return t.split("-").map((t=>{const e=H(t).trim();if(e)return function(t){return 1===(t=String(t)).length?t.toUpperCase():t.charAt(0).toUpperCase()+t.slice(1)}(e)})).join("-")}((e=t,String(e).toLowerCase())).trim();return H(n)}var e}function B(t){if(!f(t)&&!1!==t&&null!==t)return l(t)?t.join(", "):d(t)?JSON.stringify(t):H(t.toString().trim())}class F{$headers={};constructor(t,e=!0){e&&this.set(this.defaults,!1),d(t)&&!w(t)&&this.set(t,e)}static construct(t={},e=!0){return new F(t,e)}static parse(t){if(q(t)||!p(t))return{};const e={};return E(t.split("\r"),((t,n)=>{const[r,o]=n.toString().split(":"),s=k(r),i=B(o);s&&i&&(e[s]=i)})),e}get defaults(){return s.isNode?N:A}set(t,e=!0){if(!d(t))return n="Attempted to set headers with a non-object value: "+typeof t,console.error(`[urbex] ${n}`),t;var n;const r=this.normalize(t),o=e?b(this.$headers,r):r;return this.$headers=o}get(){return this.$headers}has(t){return h(this.$headers,k(t))}delete(t){E(this.$headers,(e=>{e.toLowerCase()===t.toLowerCase()&&delete this.$headers[e]}))}clear(t=!1){this.$headers={},t||this.set(this.defaults,!1)}normalize(t){return q(t)||!d(t)?{}:function(t){const e={};return E(t,((t,n)=>{if(f(t)||f(n))return;const r=k(t),o=B(n);r&&o&&(e[r]=o)})),e}(t)}}class G{constructor(){this.register(s.context),this.$cache=new t.CacheClock({autoStart:!1,debug:!1})}register(t){if("browser"!==t){if("node"!==t)throw new Error(`Urbex expected a valid context to register a request api, but got ${t}.`);this.$api=new $}else this.$api=new O}async dispatchRequest(t){try{const e=v(t),n=await async function(t){const e=Date.now(),n=(new Date).toISOString(),r=v(z);return w(t.pipelines.request)||await R.process(t,t.pipelines.request),async function(o){let i=x(r,{data:o.data,config:t,request:o.request||{},response:o.response||{},timestamp:n,responseType:t.responseType,cache:o.cache||{}});if(i.cache&&i.cache.hit){const t=200,e="Pulled from internal cache";s.isNode?(i.response.statusCode=t,i.response.statusMessage=e):(i.response.status=t,i.response.statusText=e)}if(i.response)if(i.headers=i.response.headers,s.isNode)i.status=i.response.statusCode,i.statusText=i.response.statusMessage;else{const t=F.parse(i.headers);i.headers=t,i.status=i.response.status,i.statusText=i.response.statusText}w(t.pipelines.response)||await R.process(i,t.pipelines.response);const u=Date.now()-e;return i.duration=u,Promise.resolve(i)}}(e),r=e.cache&&e.cache.enabled;if(r){const t=this.$cache.getCacheKey(e.url.href),r=this.$cache.get(t,!0);if(r){const e=await n({data:r.v,request:null,response:null,cache:{key:t,pulled:!0,hit:!0,stored:!1}});return Promise.resolve(e)}}const o=await this.$api.send(e),i=await n(o);return r&&!f(i.data)&&(this.$cache.set(e.url.href,i.data),i.cache.key=this.$cache.getCacheKey(e.url.href),i.cache.stored=!0),i.cache.hit=r,Promise.resolve(i)}catch(e){if(i.isInstance(e))return Promise.reject(e);const n=i.create(t);return n.message=e.message,Promise.reject(n)}}}const J=["stream","raw"],_=new R((t=>(S.includes(g(t.method))?t.headers.set({"Content-Type":"application/x-www-form-urlencoded"}):t.data=void 0,Promise.resolve(t)))),X=new R((async t=>{const{responseType:e,maxContentLength:n}=t.config;if(J.includes(e)||t.cache.pulled)return Promise.resolve(t);const r=t.headers["content-encoding"];if(Buffer.isBuffer(t.data)&&t.data.length){if(r){const e=U[r];if(e){const r=await e(t.data);if((n>-1||n!==1/0)&&r.length>n)throw new Error(`Content length of ${r.length} exceeds the maxContentLength of ${n}`);t.data=r}}}else t.data=null;return Promise.resolve(t)})),K=new R((t=>{const{responseType:e,responseEncoding:n}=t.config;if(J.includes(e)||"arraybuffer"===e||t.cache.pulled)return Promise.resolve(t);if(t.data){let r=t.data;s.isNode&&(r=t.data.toString(n)),t.data="json"===e?function(t,e=!1){try{return JSON.parse(t)}catch(n){return e?t:null}}(r,!0):r}return Promise.resolve(t)})),Q=/^(?:([a-z]+):\/\/)?([^:\/\n]+)/i,V=["PUT","POST","PATCH","OPTIONS","HEAD","GET","DELETE"];function W(t,e=""){const n=new URL(t),r=y(n.protocol,":",""),o=n.port?parseInt(n.port):"",s=y(n.pathname,e,"");return{href:n.href,origin:n.origin,protocol:r,hostname:n.hostname,port:o,endpoint:s,params:n.search,urlMount:e}}function Y(t,e=!0){if(p(t)){if(function(t){try{return new URL(t),!0}catch(t){return!1}}(t))return W(t);if(e)return{endpoint:P("/",t)};throw new Error("An invalid URL was provided. A valid URL string in the format of <scheme>://<hostname> must be passed when using `urbex.configure()`.")}if(d(t)){const e=T(t.protocol,Q,0,"http"),n=y(t.hostname,new RegExp(`^${e}://`,"gi"),""),r=P("/",t.endpoint),o=P("/",t.urlMount);return W(function(t){let e="{protocol+://}{hostname}{:+port}{urlMount}{endpoint}{?+params}";return q(t)||w(t)||!d(t)?"":(t.params&&(t.params=function(t,e="string"){if(q(t))return null;try{const n=new URLSearchParams(t);if("object"===e){const t={};return n.forEach(((e,n)=>{t[n]=e})),t}return n.toString()}catch(t){return null}}(t.params)),E(t,((t,n)=>{const r=new RegExp(`[{][^{{]*\\b${t}\\b[^{}]*[}]`,"gi");if(q(n)||w(n))e=y(e,r,"");else{const o=T(e,r,0,""),s=y(o,t,n.toString()).replace(/\+/g,"").replace(/^\{/,"").replace(/\}$/,"");e=y(e,o,s)}})),e)}(b(t,{protocol:e,hostname:n,endpoint:r,urlMount:o})),o)}throw new Error("Unable to parse the provided URI. Must be either a string or an object.")}function Z(){const t=b(I,{protocol:"https",urlMount:"/api"});if(s.isBrowser){const{protocol:e,hostname:n,port:r}=window.location;Object.assign(t,{protocol:e.replace(":",""),hostname:n,port:r})}else s.isNode&&Object.assign(t,{protocol:"http",hostname:"localhost",port:3e3});return t}class tt{constructor(t){this.setup(),d(t)&&!w(t)&&this.set(this.createConfigurationObject(t,!0))}setup(){const t=Y(Z()),e=v(M);e.request.push(_),e.response.push(K),s.isNode&&e.response.unshift(X);const n=x(D,{url:t,headers:new F,pipelines:e});this.set(n)}defaultConfig(){return b(D,{url:Y(Z()),headers:new F})}createConfigurationObject(t,e){const n=this.parseIncomingConfig(t,e);return this.merge(n)}parseIncomingConfig(t,e){var n,r;if(q(t)||!d(t))throw new Error("The configuration must be an object with valid properties.");const o=l(s=t)?s.slice():d(s)?Object.assign({},s):s;var s;if(h(o,"url")){const t=this.get().url;d(o.url)&&(o.url=b(t,o.url)),e&&o.url.toString().startsWith("/")&&(o.url=b(t,{endpoint:o.url}));const n=Y(o.url,e);o.url=n}if(h(o,"method")){const t=g(o.method);if(!V.includes(t))throw new Error(`The method ${t} is not a valid HTTP method.`);o.method=t}const i=parseInt((null===(n=o.timeout)||void 0===n?void 0:n.toString())??D.timeout.toString());isNaN(i)&&(o.timeout=D.timeout);const u=parseInt((null===(r=o.maxContentLength)||void 0===r?void 0:r.toString())??D.maxContentLength.toString());isNaN(u)&&(o.maxContentLength=D.maxContentLength),m(t.resolveStatus)||(t.resolveStatus=D.resolveStatus);const c=F.construct(o.headers,!0);return delete o.headers,b(o,{headers:c})}set(t){return this.$config=t,t}merge(t){var e;if(q(t)||!d(t))return this.get();const n=this.get(),r=(null===(e=t.headers)||void 0===e?void 0:e.get())??{},o=b(n.headers,r);return delete t.headers,b(x(n,t),{headers:F.construct(o)})}get(){return this.$config}reset(){this.setup()}}function et(t,e,n){if(q(e))throw new Error("Attempted to call a HTTP method without providing a URL. If you want to use the default URL, use `urbex.send` instead.");return b(n,{url:e,method:t})}class nt extends G{constructor(t){super(),this.$config=new tt,d(t)&&!w(t)&&this.configure(t)}static create(t){return new nt(t)}get config(){return this.$config.get()}get cache(){return this.$cache}configure(t){const e=this.$config.createConfigurationObject(t,!1);this.$config.set(e);const n=this.$cache;function r(){n&&(n.clear(),n.isRunning&&n.stop())}w(e.cache)?r():(n.configure(e.cache),e.cache.enabled?n&&n.isRunning||n.start():!1===e.cache.enabled&&r())}send(t={}){const e=this.$config.parseIncomingConfig(t,!0),n=this.$config.merge(e);return this.dispatchRequest(n)}injectPipeline(){}ejectPipeline(){}subscribe(){}unsubscribe(){}reset(){this.$cache&&(this.$cache.clear(),this.$cache.isRunning&&this.$cache.stop()),this.$config.reset()}}function rt(t){return t instanceof nt}E(["delete","get","head","options"],((t,e)=>{nt.prototype[e]=function(t,n){return this.send(et(g(e),t,n))}})),E(["post","put","patch"],((t,e)=>{nt.prototype[e]=function(t,n,r){const o=f(n)?n:d(r)?b(r,{data:n}):{data:n};return this.send(et(g(e),t,o))}}));const ot=function(){const t=nt.create();return t.isolateClient=nt.create,t.environment=s,t.isUrbexClient=rt,t.Client=nt,t}();exports.PipelineExecutor=R,exports.default=ot;
//# sourceMappingURL=urbex.min.cjs.map
